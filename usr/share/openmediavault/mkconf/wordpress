#!/bin/sh
#
# @license   http://www.gnu.org/licenses/gpl.html GPL Version 3
# Copyright (C) 2013 OpenMediaVault Plugin Developers
#
# This file is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.
#
# This file is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this file. If not, see <http://www.gnu.org/licenses/>.

set -e

. /etc/default/openmediavault
. /usr/share/openmediavault/scripts/helper-functions

WORDPRESS_CONFIG="/var/www/wordpress/wp-config.php"
WORDPRESS_SITE_CONF_NAME=openmediavault-wordpress-site
WORDPRESS_SITE_ENABLED_CONF=/etc/apache2/sites-enabled/${WORDPRESS_SITE_CONF_NAME}

# Enable/disable site
if [ "$(omv_config_get "//services/wordpress/enable")" != "1" ]; then
    if [ -e ${WORDPRESS_SITE_ENABLED_CONF} ]; then
        a2dissite ${WORDPRESS_SITE_CONF_NAME}
        /etc/init.d/apache2 reload
    fi

    exit 0
fi

DB_HOST=$(omv_config_get "//services/wordpress/db_host")
DB_USER=$(omv_config_get "//services/wordpress/db_user")
DB_PASS=$(omv_config_get "//services/wordpress/db_pass")
DB_NAME=$(omv_config_get "//services/wordpress/db_name")

AUTH_KEY=$(omv_config_get "//services/wordpress/auth_key")
SECURE_AUTH_KEY=$(omv_config_get "//services/wordpress/secure_auth_key")
LOGGED_IN_KEY=$(omv_config_get "//services/wordpress/logged_in_key")
NONCE_KEY=$(omv_config_get "//services/wordpress/nonce_key")

AUTH_SALT=$(omv_config_get "//services/wordpress/auth_salt")
SECURE_AUTH_SALT=$(omv_config_get "//services/wordpress/secure_auth_salt")
LOGGED_IN_SALT=$(omv_config_get "//services/wordpress/logged_in_salt")
NONCE_SALT=$(omv_config_get "//services/wordpress/nonce_salt")

cat <<EOF > ${WORDPRESS_CONFIG}
<?php
//this file is automatically generated.

define('DB_NAME', '${DB_NAME}');
define('DB_USER', '${DB_USER}');
define('DB_PASSWORD', '${DB_PASS}');
define('DB_HOST', '${DB_HOST}');

define('DB_CHARSET', 'utf8');
define('DB_COLLATE', '');

define('AUTH_KEY',         '${AUTH_KEY}');
define('SECURE_AUTH_KEY',  '${SECURE_AUTH_KEY}');
define('LOGGED_IN_KEY',    '${LOGGED_IN_KEY}');
define('NONCE_KEY',        '${NONCE_KEY}');
define('AUTH_SALT',        '${AUTH_SALT}');
define('SECURE_AUTH_SALT', '${SECURE_AUTH_SALT}');
define('LOGGED_IN_SALT',   '${LOGGED_IN_SALT}');
define('NONCE_SALT',       '${NONCE_SALT}');

\$table_prefix = 'wp_';
define('WPLANG', '');

define('WP_DEBUG', false);
if ( !defined('ABSPATH') )
	define('ABSPATH', dirname(__FILE__) . '/');

require_once(ABSPATH . 'wp-settings.php');
EOF

a2enmod rewrite
a2ensite ${WORDPRESS_SITE_CONF_NAME}
/etc/init.d/apache2 reload
